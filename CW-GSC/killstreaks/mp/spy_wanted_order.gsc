/***********************************************
 * Decompiled by Ate47 and Edited by SyndiShanX
 * Script: killstreaks\mp\spy_wanted_order.gsc
***********************************************/

#using scripts\autogenerated\luielems\hud_spy;
#using scripts\core_common\callbacks_shared;
#using scripts\core_common\clientfield_shared;
#using scripts\core_common\flag_shared;
#using scripts\core_common\system_shared;
#using scripts\core_common\util_shared;
#using scripts\killstreaks\killstreaks_shared;
#namespace spy_wanted_order;

function private autoexec __init__system__() {
  system::register(#"spy_wanted_order", &preinit, undefined, undefined, #"killstreaks");
}

function private preinit() {
  killstreaks::register_killstreak("killstreak_spy_wanted_order", &function_cd089b2e);
  callback::on_weapon_change(&on_weapon_change);
  level.var_e9e1396f = {};
}

function function_cd089b2e(killstreaktype) {
  result = 0;
  assert(isPlayer(self));
  assert(isalive(self));
  assert(isDefined(level.spyhud));
  player = self;

  if(player isinair() || player isplayerunderwater() || player isplayerswimming() || player isplayerwallrunning()) {
    return 0;
  }

  player callback::add_callback(#"underwater", &function_84845e32);
  player allowmelee(0);
  player disableweaponfire();
  player disableoffhandweapons();
  player allowmovement(0);
  player function_fe89725a(1);
  player function_205350ab();
  player disableweaponcycling();
  player setclientuivisibilityflag("hud_visible", 0);

  if(isDefined(level.spyhud)) {
    assert(isDefined(level.var_8811f9ea));
    var_1ad7055e = [[level.var_8811f9ea]]();
    var_b8155147 = isarray(var_1ad7055e) ? var_1ad7055e.size : 0;
    level clientfield::set_world_uimodel("hudItems.spyMatchData.playerCount", var_b8155147);
    level clientfield::set_world_uimodel("hudItems.spyMatchData.deadPlayerCount", var_b8155147 - function_a1ef346b().size);
    util::wait_network_frame(1);

    if(!isDefined(player)) {
      return;
    }

    level.spyhud hud_spy::set_state(player, "WantedOrderMenu");
    player flag::set("selectingWantedPlayer");
    player thread function_eb585639();
    event = player waittill(#"player_selected", #"hash_91a93ea58d7ad74", #"death", #"disconnect", #"game_ended");

    if(event._notify === "player_selected") {
      result = 1;
    }

    waitframe(1);

    if(!isDefined(player)) {
      return;
    }

    player flag::clear("selectingWantedPlayer");
    level.spyhud hud_spy::set_state(player, "CombatHud");
  }

  player callback::remove_callback(#"underwater", &function_84845e32);
  player allowmelee(1);
  player enableweaponfire();
  player enableoffhandweapons();
  player allowmovement(1);
  player function_fe89725a(0);
  player function_6e1804bd();
  player enableweaponcycling();
  player setclientuivisibilityflag("hud_visible", 1);
  return result;
}

function private on_weapon_change(params) {
  if(!self flag::get("selectingWantedPlayer")) {
    return;
  }

  curweapon = self getcurrentweapon();
  var_465632db = getweapon(#"spy_wanted_order");

  if(curweapon != var_465632db) {
    self notify(#"hash_91a93ea58d7ad74");
  }
}

function private function_84845e32(params) {
  if(!self flag::get("selectingWantedPlayer")) {
    return;
  }

  self notify(#"hash_91a93ea58d7ad74");
}

function private function_eb585639() {
  self endon(#"disconnect", #"death", #"hash_91a93ea58d7ad74", #"player_selected");
  level endon(#"game_ended");

  while(true) {
    waitresult = self waittill(#"menuresponse");
    menu = waitresult.menu;
    response = waitresult.response;
    clientnum = waitresult.intpayload;

    if(menu == "wanted_order_menu") {
      if(response == "cancel") {
        self notify(#"hash_91a93ea58d7ad74");
        return;
      }

      if(response == "player_selected") {
        self notify(#"player_selected", {
          #playerclientnum: clientnum
        });
        return;
      }
    }

    wait float(function_60d95f53()) / 1000;
  }
}